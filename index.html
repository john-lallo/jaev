<!DOCTYPE HTML>

<html>

<head>
	<meta charset = 'utf-8'>
	<title>j√§ev-dev</title>
	<style>
		html, body{
			padding: 0;
			margin: 0;

			background-color: #222222;
			color: #666666;
		}

		#world{

			overflow: hidden;

			position: relative;

			margin: 40px;

			width: 1024px;
			height: 720px;

			border: 1px dashed #888888;
		}

		.particle {
			width: 4px;
			height: 4px;

			background-color: #888888;
			border: none;
			border-radius: 100%;
		}

		.circle {
			/*background-color: #888888;*/
			border: 1px solid #888888;
			border-radius: 100%;
		}
	</style>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src = './vector.js' language = 'javascript'></script>
	<script language = 'javascript'>
		var index = 0;

		//...............................................................................CIRCLE ITEM
		var Circle = function(args){

			this.type = 2;

			this.inv_mass = 1 / args.mass;
			this.e = args.restitution;

			this.pos = new vector(args.x, args.y);
			this.prev = new vector(args.x, args.y);

			this.radius = args.radius;

			this.fixated = args.fixated;

			this.accel = new vector(0, 0);

			$('#world').append(
			'<div id = "'
				+ index +
			'" class = "circle" style = "position: absolute; left: 0; bottom: 0; width: '
				+ (this.radius * 2 - 1) +
			'px; height: '
				+ (this.radius * 2 - 1) +
			'px; transform: translate3d('
				+ (this.pos.x - this.radius) + 'px, ' + (-this.pos.y + this.radius) +
			'px, 0) rotate('
				+ 0 +
			'rad);"></div>'
			);

			this.element = document.getElementById(index);

			console.log('new circle');
			++index;

		}

		Circle.prototype = {
			accelerate: function(v){if(!this.fixated){this.accel.iadd(v);} },
			correct: function(v){ if(!this.fixated){this.pos.iadd(v);} },
			step: function(dt){
				this.accel.imul(dt * dt);
				
				var updated_pos = this.pos.mul(2).sub(this.prev).add(this.accel);

				this.prev = this.pos;
				this.pos = updated_pos;
				this.accel.zero();
			},
			sync: function(){
				this.element.style.transform =
				'translate3d('
					+ (this.pos.x - this.radius) + 'px, '
					+ (-this.pos.y + this.radius) +	'px, 0) rotate('
					+ 0 +
				'rad)';

			}
		}

		//...............................................................................COLLISION RESOLUTION
		var Collide = function(a, b, impulse_preservation){
			var target = a.radius + b.radius;
			var N = b.pos.sub(a.pos);

			if(N.magnitude2() < target * target){

				N.normalize();
				
				var v0a = a.pos.sub(a.prev);
				var v0b = b.pos.sub(b.prev);

				//resolve collision constraint
				var delta = target - b.pos.sub(a.pos).magnitude();
				a.correct(
					N.mul(-0.5 * delta)
				);
				//a.prev = a.pos;
				b.correct(
					N.mul(0.5 * delta)
				);
				//b.prev = b.pos;

				//exchange impulses
				if(impulse_preservation){
					var dt = 1;
					var e = Math.min(a.e, b.e);

					var Iex = (1 + e) * v0b.sub(v0a).dot(N) / (a.inv_mass + b.inv_mass);

					var va = v0a.add(N.mul(Iex * a.inv_mass));
					var vb = v0b.add(N.mul(-Iex * b.inv_mass));

					a.prev = a.pos.sub(va.mul(dt));
					b.prev = b.pos.sub(vb.mul(dt));
				}

			}
		}


		//...............................................................................CONSTRAINT RESOLUTION
		var const_count = 0;

		var distConstraint = function(a, b){
			this.index = const_count;
			this.a = a;
			this.b = b;
			this.target = b.pos.sub(a.pos).magnitude();

			++const_count;
		}

		distConstraint.prototype = {
			resolve: function(){
				var direction = this.b.pos.sub(this.a.pos);
				var L = direction.magnitude();
				var factor = (L - this.target) /L/2;
				var correction = direction.mul(factor);
				this.a.correct(correction);
				correction.imul(-1);
				this.b.correct(correction);
			},
		}



		//...............................................................................WORLD
		var elem = [];
		var constraints = [];

		$(document).ready(function(){
			
			$('#world').on('click', clickHandler);

			elem[0] = new Circle({
				x: 500,
				y: 200,
				radius: 80,
				mass: 100000,
				restitution: 0.5,
				fixated: true,
			});

			timestep();
		});



		//...............................................................................INTERFACE
		var default_circle = { x: 500, y: 500, radius: 20, mass: 1, restitution: 0.5}

		function createCircle(args){
			elem[index] = new Circle({
					x: args.x || default_circle.x,
					y: args.y || default_circle.y,
					radius: args.radius || default_circle.radius,
					mass: args.mass || default_circle.mass,
					restitution: args.restitution || default_circle.restitution,
			});
		}


		var default_particle = {x: 500,	y: 500,	mass: 1, restitution: 1}

		function createParticle(args){
			elem[index] = new Circle({
					x: args.x || default_particle.x,
					y: args.y || default_particle.y,
					radius: 1,
					mass: args.mass || default_particle.mass,
					restitution: args.restitution || default_particle.restitution,
			});
			//constraints[const_count] = new distConstraint(elem[index - 1], elem[index - 2]);
		}




		function clickHandler(event){
			var w = document.getElementById("world");
			var x = event.pageX - $("#world").offset().left;
			var y = 720 - (event.pageY - $("#world").offset().top);

			//if(Math.floor(2 * Math.random()) % 2){
			createCircle({x: x, y: y, radius: Math.random() * 40});
			/*} else {
			createParticle({x: x, y: y});
			}
			*/
		}


		//...............................................................................TIMESTEPPING
		var iter = 10;
		var dt = 1 / iter;

		var gravity = new vector(0, -1);
		function timestep(){

			for(var t = 0; t < iter; ++t){

				//particle constraints
				for(var i = 0; i < constraints.length; ++i){constraints[i].resolve();}

				for(var i = 0; i < elem.length; ++i){ elem[i].accelerate(gravity);}

				//collision resolution
				for(var i = 0; i < elem.length; ++i){
				for(var j = i + 1; j < elem.length; ++j){
					Collide(elem[i], elem[j], false);
				}	
				}

				//propagation
				for(var i = 0; i < elem.length; ++i){ elem[i].step(dt);}

				for(var i = 0; i < elem.length; ++i){
				for(var j = i + 1; j < elem.length; ++j){
					Collide(elem[i], elem[j], true);
				}	
				}


				//placeholder ground constraint
				for(var i = 0; i < elem.length; ++i){
					if(elem[i].pos.y - (0 || elem[i].radius) < 0){ elem[i].pos.y = elem[i].radius;}
				}
				
			}

			for(var i = 0; i < elem.length; ++i){
				elem[i].sync();
			}

			window.requestAnimationFrame(timestep);
		}
	</script>

</head>

<body>
	<div id = "world">

	</div>
</body>

</html>
